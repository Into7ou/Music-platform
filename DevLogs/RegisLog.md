# æ³¨å†ŒåŠŸèƒ½ - é€»è¾‘æµç¨‹æ–‡æ¡£

> **æ¨¡å—**: User æ¨¡å—  
> **åŠŸèƒ½**: ç”¨æˆ·æ³¨å†Œ  
> **æ¥å£**: `POST /auth/register`  
> **åˆ›å»ºæ—¶é—´**: 2025-12-18  
> **çŠ¶æ€**: âœ… å·²å®ç°ï¼ˆåŸºç¡€ç‰ˆæœ¬ï¼‰

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·é€šè¿‡æäº¤ç”¨æˆ·åå’Œå¯†ç å®Œæˆè´¦å·æ³¨å†Œï¼Œç³»ç»Ÿå°†ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–åˆ° `user_db` æ•°æ®åº“çš„ `sys_user` è¡¨ä¸­ã€‚

---

## äºŒã€è¯·æ±‚/å“åº”è§„èŒƒ

### è¯·æ±‚

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **URL** | `/auth/register` |
| **Method** | `POST` |
| **Content-Type** | `application/json` |

**è¯·æ±‚ä½“ç¤ºä¾‹**:
```json
{
    "username": "testuser",
    "password": "123456"
}
```

### å“åº”

**æˆåŠŸå“åº”** (HTTP 200):
```json
{
    "code": 200,
    "msg": "Success",
    "data": "æ³¨å†ŒæˆåŠŸ"
}
```

**å¤±è´¥å“åº”** (ç”¨æˆ·åå·²å­˜åœ¨):
```json
{
    "code": 500,
    "msg": "ç”¨æˆ·åå·²å­˜åœ¨",
    "data": null
}
```

---

## ä¸‰ã€æ ¸å¿ƒæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·æ³¨å†Œæµç¨‹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Client  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚ POST /auth/register
         â”‚ {username, password}
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Controller] AuthController.register()                                      â”‚
â”‚  - æ¥æ”¶è¯·æ±‚ä½“ï¼Œè‡ªåŠ¨ååºåˆ—åŒ–ä¸º UserLoginDTO                                    â”‚
â”‚  - @Validated è§¦å‘å‚æ•°æ ¡éªŒ                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Service] UserService.register()                                            â”‚
â”‚  - @DS("user") åˆ‡æ¢åˆ° user_db æ•°æ®æº                                         â”‚
â”‚                                                                             â”‚
â”‚  Step 1: æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨                                                â”‚
â”‚          â”œâ”€â”€ è°ƒç”¨ userMapper.selectByUsername(username)                     â”‚
â”‚          â””â”€â”€ å¦‚æœè¿”å›é null â†’ è¿”å› Result.error("ç”¨æˆ·åå·²å­˜åœ¨")              â”‚
â”‚                                                                             â”‚
â”‚  Step 2: æ„å»º User å®ä½“å¯¹è±¡                                                  â”‚
â”‚          â”œâ”€â”€ user.setUsername(req.getUsername())                            â”‚
â”‚          â”œâ”€â”€ user.setNickname("ç”¨æˆ·" + éšæœºæ•°)  // é»˜è®¤æ˜µç§°                   â”‚
â”‚          â””â”€â”€ user.setPassword(req.getPassword()) // âš ï¸ å½“å‰æ˜æ–‡å­˜å‚¨          â”‚
â”‚                                                                             â”‚
â”‚  Step 3: æŒä¹…åŒ–åˆ°æ•°æ®åº“                                                      â”‚
â”‚          â”œâ”€â”€ è°ƒç”¨ userMapper.insert(user)                                   â”‚
â”‚          â””â”€â”€ è¿”å› Result.success("æ³¨å†ŒæˆåŠŸ")                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Mapper] UserMapper (Interface + XML)                                       â”‚
â”‚                                                                             â”‚
â”‚  selectByUsername:                                                          â”‚
â”‚    SELECT id, username, password, nickname, avatar, create_time             â”‚
â”‚    FROM sys_user WHERE username = #{username}                               â”‚
â”‚                                                                             â”‚
â”‚  insert:                                                                    â”‚
â”‚    INSERT INTO sys_user (username, password, nickname, avatar, create_time) â”‚
â”‚    VALUES (#{username}, #{password}, #{nickname}, #{avatar}, NOW())         â”‚
â”‚    -- useGeneratedKeys="true" è‡ªåŠ¨å›å¡«ä¸»é”® ID                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Database] MySQL - user_db.sys_user                                         â”‚
â”‚                                                                             â”‚
â”‚  è¡¨ç»“æ„:                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ å­—æ®µ        â”‚ ç±»å‹         â”‚ è¯´æ˜                            â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚ id         â”‚ BIGINT(PK)   â”‚ ä¸»é”®ï¼Œè‡ªå¢                       â”‚            â”‚
â”‚  â”‚ username   â”‚ VARCHAR      â”‚ ç”¨æˆ·åï¼Œå”¯ä¸€                     â”‚            â”‚
â”‚  â”‚ password   â”‚ VARCHAR      â”‚ å¯†ç ï¼ˆå½“å‰æ˜æ–‡ï¼‰                  â”‚            â”‚
â”‚  â”‚ nickname   â”‚ VARCHAR      â”‚ æ˜µç§°                            â”‚            â”‚
â”‚  â”‚ avatar     â”‚ VARCHAR      â”‚ å¤´åƒURL                         â”‚            â”‚
â”‚  â”‚ create_timeâ”‚ DATETIME     â”‚ åˆ›å»ºæ—¶é—´                         â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ä»£ç æ–‡ä»¶æ¸…å•

| å±‚çº§ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| **Controller** | `modules/user/controller/AuthController.java` | æ¥æ”¶HTTPè¯·æ±‚ï¼Œè°ƒç”¨Service |
| **Service** | `modules/user/service/UserService.java` | ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæ•°æ®æºåˆ‡æ¢ |
| **Mapper** | `modules/user/mapper/UserMapper.java` | MyBatis æ¥å£å®šä¹‰ |
| **Mapper XML** | `resources/mapper/user/UserMapper.xml` | SQL è¯­å¥å®ç° |
| **Entity** | `modules/user/model/entity/User.java` | ç”¨æˆ·å®ä½“ç±» |
| **DTO** | `modules/user/model/dto/UserLoginDTO.java` | è¯·æ±‚å‚æ•°å°è£… |
| **Result** | `common/result/Result.java` | ç»Ÿä¸€å“åº”æ ¼å¼ |

---

## äº”ã€å…³é”®ä»£ç ç‰‡æ®µ

### 5.1 Controller å±‚

```java
@RestController
@RequestMapping("/auth")
@CrossOrigin(origins = "*")
public class AuthController {

    @Autowired
    private UserService userService;

    @PostMapping("/register")
    public Result<String> register(@RequestBody @Validated UserLoginDTO req) {
        return userService.register(req);
    }
}
```

**è¦ç‚¹**:
- `@RequestBody`: å°† JSON è‡ªåŠ¨ååºåˆ—åŒ–ä¸º DTO
- `@Validated`: è§¦å‘ JSR-303 å‚æ•°æ ¡éªŒ
- `@CrossOrigin`: å…è®¸è·¨åŸŸè¯·æ±‚ï¼ˆå‰ç«¯è°ƒç”¨ï¼‰

---

### 5.2 Service å±‚

```java
@Service
@DS("user") // åˆ‡æ¢åˆ° user_db æ•°æ®æº
public class UserService {

    @Autowired
    private UserMapper userMapper;

    public Result<String> register(UserLoginDTO req) {
        // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        User existUser = userMapper.selectByUsername(req.getUsername());
        if (existUser != null) {
            return Result.error("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // 2. æ„å»ºç”¨æˆ·å¯¹è±¡
        User user = new User();
        user.setUsername(req.getUsername());
        user.setNickname("ç”¨æˆ·" + System.currentTimeMillis() % 1000);
        user.setPassword(req.getPassword()); // âš ï¸ æ˜æ–‡å­˜å‚¨

        // 3. å†™å…¥æ•°æ®åº“
        userMapper.insert(user);
        return Result.success("æ³¨å†ŒæˆåŠŸ");
    }
}
```

**è¦ç‚¹**:
- `@DS("user")`: Dynamic Datasource æ³¨è§£ï¼ŒæŒ‡å®šä½¿ç”¨ `user_db`
- å…ˆæŸ¥åæ’ï¼Œé˜²æ­¢ç”¨æˆ·åé‡å¤

---

### 5.3 Mapper å±‚

**æ¥å£å®šä¹‰** (`UserMapper.java`):
```java
@Mapper
public interface UserMapper {
    User selectByUsername(@Param("username") String username);
    int insert(User user);
}
```

**XML å®ç°** (`UserMapper.xml`):
```xml
<mapper namespace="com.intomusic.musicplatform.modules.user.mapper.UserMapper">

    <select id="selectByUsername" resultType="User">
        SELECT id, username, password, nickname, avatar, create_time
        FROM sys_user
        WHERE username = #{username}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_user (username, password, nickname, avatar, create_time)
        VALUES (#{username}, #{password}, #{nickname}, #{avatar}, NOW())
    </insert>

</mapper>
```

**è¦ç‚¹**:
- `resultType="User"`: ä¾èµ– `application.yml` ä¸­çš„ `type-aliases-package` é…ç½®
- `useGeneratedKeys="true"`: æ’å…¥åè‡ªåŠ¨å›å¡«è‡ªå¢ä¸»é”®åˆ°å®ä½“

---

## å…­ã€æ•°æ®æµå‘å›¾

```
[å‰ç«¯è¯·æ±‚]
    â”‚
    â”‚  POST /auth/register
    â”‚  {"username": "test", "password": "123"}
    â–¼
[AuthController]
    â”‚
    â”‚  è‡ªåŠ¨æ³¨å…¥ UserLoginDTO
    â”‚  è°ƒç”¨ userService.register(dto)
    â–¼
[UserService]  â† @DS("user") åˆ‡æ¢æ•°æ®æº
    â”‚
    â”œâ”€â–º [UserMapper.selectByUsername] â”€â”€â–º user_db.sys_user (æŸ¥è¯¢)
    â”‚         â”‚
    â”‚         â–¼
    â”‚   å­˜åœ¨? â”€â”€Yesâ”€â”€â–º è¿”å› Result.error("ç”¨æˆ·åå·²å­˜åœ¨")
    â”‚         â”‚
    â”‚        No
    â”‚         â–¼
    â”œâ”€â–º [UserMapper.insert] â”€â”€â–º user_db.sys_user (æ’å…¥)
    â”‚
    â–¼
[è¿”å› Result.success("æ³¨å†ŒæˆåŠŸ")]
    â”‚
    â–¼
[å‰ç«¯æ¥æ”¶]
    {"code": 200, "msg": "Success", "data": "æ³¨å†ŒæˆåŠŸ"}
```

---

## ä¸ƒã€å¾…ä¼˜åŒ–äº‹é¡¹

| ä¼˜å…ˆçº§ | äº‹é¡¹ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ |
|--------|------|----------|----------|
| ğŸ”´ é«˜ | å¯†ç å­˜å‚¨ | æ˜æ–‡å­˜å‚¨ | BCrypt/MD5 åŠ å¯† |
| ğŸŸ¡ ä¸­ | å‚æ•°æ ¡éªŒ | æ— æ ¡éªŒè§„åˆ™ | æ·»åŠ  `@NotBlank`, `@Size` ç­‰ |
| ğŸŸ¡ ä¸­ | å”¯ä¸€çº¦æŸ | ä»…ä»£ç å±‚æ£€æŸ¥ | æ•°æ®åº“æ·»åŠ  UNIQUE ç´¢å¼• |
| ğŸŸ¢ ä½ | é»˜è®¤æ˜µç§° | æ—¶é—´æˆ³å–æ¨¡ | æ›´å‹å¥½çš„éšæœºæ˜µç§°ç”Ÿæˆ |

---

## å…«ã€æµ‹è¯•ç”¨ä¾‹

### æ­£å¸¸æ³¨å†Œ

```bash
curl -X POST http://localhost:8080/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "newuser", "password": "password123"}'
```

### é‡å¤æ³¨å†Œï¼ˆé¢„æœŸå¤±è´¥ï¼‰

```bash
curl -X POST http://localhost:8080/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "newuser", "password": "password123"}'
```

---

## ä¹ã€ç‰ˆæœ¬è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| v1.0 | 2025-12-18 | åˆå§‹ç‰ˆæœ¬ï¼Œå®ç°åŸºç¡€æ³¨å†ŒåŠŸèƒ½ |
